<!DOCTYPE html>
<html>
<head>
    <title>Trang ch·ªß</title>
    <link rel="stylesheet" href="/static/home.css">
    <script>
        function toggleCreateNote() {
            var form = document.getElementById('create-note');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <div class="home-container">
        <div class="btn-logout">
            <button onclick="window.location.href='/auth/login'">Logout</button>
        </div>
        <div class="home__form">
            <div class="home__content">
                <h1 class="home__title">Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi Notepad !</h1>
                <!-- Menu -->
                <nav class="menu-bar">
                    <button type="button" class="btn-menu" onclick="toggleCreateNote()">
                        <span style="font-size:18px;">&#9998;</span> T·∫°o ghi ch√∫
                    </button>
                    <a href="/home" class="btn-menu btn-menu-secondary">
                        <span style="font-size:18px;">&#128196;</span> Xem t·∫•t c·∫£ ghi ch√∫
                    </a>
                    <span style="margin-left:10px;">Xem theo ph√¢n lo·∫°i:</span>
                    <form method="get" action="/home" style="display:inline;">
                        <select name="category_id" onchange="this.form.submit()">
                            <option value="">-- T·∫•t c·∫£ --</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </nav>
                <!-- N√∫t b·∫•m ƒë·ªÉ hi·ªán form th√™m ph√¢n lo·∫°i v√† n√∫t th·ªëng k√™ -->
                <div class="button-group" style="display: flex; gap: 12px; margin-bottom: 16px;">
                    <button type="button" class="btn-menu" onclick="toggleCreateCategory()">
                        <span style="font-size:18px;">&#10133;</span> Th√™m ph√¢n lo·∫°i
                    </button>
                    <button type="button" class="btn-menu btn-menu-secondary" onclick="showStatsModal()">
                        <span style="font-size:18px;">üìä</span> Th·ªëng k√™
                    </button>
                </div>
                <!-- Modal th·ªëng k√™ -->
                <div id="stats-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:1000; align-items:center; justify-content:center;">
                    <div style="background:#fff; padding:32px 24px 16px 24px; border-radius:10px; min-width:320px; max-width:90vw; margin:40px auto; position:relative; box-shadow:0 2px 16px rgba(0,0,0,0.2);">
                        <h3 style="margin-top:0;">Bi·ªÉu ƒë·ªì th·ªëng k√™ ghi ch√∫ theo ph√¢n lo·∫°i</h3>
                        <canvas id="statsChart" width="400" height="300"></canvas>
                        <div style="text-align:center; margin-top:18px;">
                            <button onclick="closeStatsModal()" class="btn btn--submit">ƒê√≥ng</button>
                        </div>
                    </div>
                </div>
                <!-- Form t·∫°o category m·ªõi -->
                <div id="create-category" style="margin-bottom: 30px; display: none;">
                    <form action="/categories/" method="post" class="create-category-form">
                        <div style="flex:1;">
                            <label for="cat_name">T√™n ph√¢n lo·∫°i m·ªõi:</label>
                            <input type="text" id="cat_name" name="name" required>
                        </div>
                        <div style="flex:2;">
                            <label for="cat_desc">M√¥ t·∫£:</label>
                            <input type="text" id="cat_desc" name="description">
                        </div>
                        <button type="submit" class="btn btn--submit">Th√™m ph√¢n lo·∫°i</button>
                    </form>
                </div>
                <!-- Form t·∫°o/s·ª≠a ghi ch√∫ -->
                {% if note_to_edit %}
                <div id="edit-note" style="margin-bottom: 30px;">
                    <form action="/notes/update" method="post">
                        <input type="hidden" name="note_id" value="{{ note_to_edit.id }}">
                        <label for="edit_title">Ti√™u ƒë·ªÅ:</label>
                        <input type="text" id="edit_title" name="title" required value="{{ note_to_edit.title }}"><br>
                        <label for="edit_content">N·ªôi dung:</label>
                        <div style="margin-bottom: 6px;">
                            <button type="button" onclick="insertTag('<b>', '</b>', 'edit_content')"><b>B</b></button>
                            <button type="button" onclick="insertTag('<i>', '</i>', 'edit_content')"><i>I</i></button>
                            <button type="button" onclick="insertTag('<ul><li>', '</li></ul>', 'edit_content')">UL</button>
                        </div>
                        <textarea id="edit_content" name="content" required style="width:100%;height:60px;">{{ note_to_edit.content }}</textarea><br>
                        <label for="edit_category">Lo·∫°i ghi ch√∫:</label>
                        <select id="edit_category" name="category_id" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id == note_to_edit.category_id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select><br>
                        <button type="submit" class="btn btn--submit">C·∫≠p nh·∫≠t ghi ch√∫</button>
                        <a href="/home" style="margin-left:10px;">H·ªßy</a>
                    </form>
                </div>
                {% else %}
                <div id="create-note" style="margin-bottom: 30px; display: none;">
                    <form action="/notes/create" method="post">
                        <label for="title">Ti√™u ƒë·ªÅ:</label>
                        <input type="text" id="title" name="title" required><br>
                        <label for="content">N·ªôi dung:</label>
                        <!-- C√°c n√∫t ƒë·ªãnh d·∫°ng -->
                        <div style="margin-bottom: 6px;">
                            <button type="button" onclick="insertTag('<b>', '</b>')"><b>B</b></button>
                            <button type="button" onclick="insertTag('<i>', '</i>')"><i>I</i></button>
                            <button type="button" onclick="insertTag('<ul><li>', '</li></ul>')">UL</button>
                        </div>
                        <textarea id="content" name="content" required style="width:100%;height:60px;"></textarea><br>
                        <label for="category">Lo·∫°i ghi ch√∫:</label>
                        <select id="category" name="category_id" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select><br>
                        <button type="submit" class="btn btn--submit">T·∫°o ghi ch√∫</button>
                    </form>
                </div>
                {% endif %}
                <!-- Danh s√°ch ghi ch√∫ -->
                <h2 style="margin-bottom:10px;">Danh s√°ch ghi ch√∫ c·ªßa b·∫°n</h2>
                <!-- Th·ªëng k√™ s·ªë note theo ph√¢n lo·∫°i -->
                {% if notes and notes|length > 0 %}
                    <ul class="note-list">
                    {% for note in notes %}
                        <li>
                            <span class="note-title">{{ note.title }}</span>
                            <span class="note-date">
                                ({% if note.created_at %}
                                    {# N·∫øu l√† datetime object #}
                                    {% if note.created_at.strftime is defined %}
                                        {{ note.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        {# N·∫øu l√† string ISO, c·∫Øt chu·ªói #}
                                        {{ note.created_at[:16].replace('T', ' ') }}
                                    {% endif %}
                                {% endif %})
                            </span><br>
                            <div style="margin: 8px 0;">{{ note.content | safe }}</div>
                            <span class="note-category">Ph√¢n lo·∫°i: 
                                {% for category in categories %}
                                    {% if category.id == note.category_id %}{{ category.name }}{% endif %}
                                {% endfor %}
                            </span>
                            <form action="/notes/delete" method="post" style="display:inline; margin-left:10px;">
                                <input type="hidden" name="note_id" value="{{ note.id }}">
                                <button type="submit" class="btn btn--delete" title="X√≥a ghi ch√∫" onclick="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ghi ch√∫ n√†y?');" style="background:none; border:none; cursor:pointer; padding:0;">
                                    <!-- Trash icon SVG m√†u ƒë·ªè -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </form>
                            <form action="/home" method="get" style="display:inline;">
                                <input type="hidden" name="edit_id" value="{{ note.id }}">
                                <button type="submit" class="btn btn--edit" title="S·ª≠a ghi ch√∫" style="background:none; border:none; cursor:pointer; padding:0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 5H6a2 2 0 0 0-2 2v11.5A1.5 1.5 0 0 0 5.5 20H17a2 2 0 0 0 2-2v-5"/>
                                        <path d="M16.121 3.879a3 3 0 1 1 4.243 4.243L12 16.5l-4 1 1-4 7.121-7.121z"/>
                                    </svg>
                                </button>
                            </form>

                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p style="color:var(--gray);">B·∫°n ch∆∞a c√≥ ghi ch√∫ n√†o.</p>
                {% endif %}
            </div>
        </div>
        <div class="circle circle--red"></div>
        <div class="circle circle--yellow"></div>
        <div class="circle circle--green"></div>
        <div class="circle circle--purple"></div>
    </div>
</body>
</html>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function insertTag(openTag, closeTag, textareaId) {
    var textarea = document.getElementById(textareaId || 'content');
    var start = textarea.selectionStart;
    var end = textarea.selectionEnd;
    var text = textarea.value;
    var before = text.substring(0, start);
    var selected = text.substring(start, end);
    var after = text.substring(end, text.length);
    textarea.value = before + openTag + selected + closeTag + after;
    // ƒê·∫∑t l·∫°i v·ªã tr√≠ con tr·ªè
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + openTag.length + selected.length + closeTag.length;
}

function showStatsModal() {
    document.getElementById('stats-modal').style.display = 'flex';
    // L·∫•y d·ªØ li·ªáu t·ª´ template
    const labels = [
        {% for category in categories %}'{{ category.name }}'{% if not loop.last %}, {% endif %}{% endfor %}
    ];
    const rawData = [
        {% for category in categories %}{{ note_count_by_category[category.id] if note_count_by_category and category.id in note_count_by_category else 0 }}{% if not loop.last %}, {% endif %}{% endfor %}
    ];
    const total = rawData.reduce((a, b) => a + b, 0);
    const data = rawData.map(x => total > 0 ? Math.round(x * 1000 / total) / 10 : 0); // ph·∫ßn trƒÉm, 1 s·ªë th·∫≠p ph√¢n
    // V·∫Ω bi·ªÉu ƒë·ªì
    setTimeout(function() { // ƒê·∫£m b·∫£o canvas ƒë√£ render
        const ctx = document.getElementById('statsChart').getContext('2d');
        if(window.statsChartInstance) window.statsChartInstance.destroy();
        window.statsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'T·ª∑ l·ªá (%)',
                    data: data,
                    backgroundColor: 'rgba(54, 162, 235, 0.5)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1,
                    rawCounts: rawData // gi·ªØ l·∫°i s·ªë note th·ª±c t·∫ø ƒë·ªÉ tooltip
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const idx = context.dataIndex;
                                const percent = context.dataset.data[idx];
                                const count = context.dataset.rawCounts[idx];
                                return `S·ªë ghi ch√∫: ${count}  (${percent}%)`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) { return value + '%'; }
                        }
                    }
                }
            }
        });
    }, 100);
}
function closeStatsModal() {
    document.getElementById('stats-modal').style.display = 'none';
}
</script>

<script>
    function toggleCreateCategory() {
        var form = document.getElementById('create-category');
        if (form.style.display === 'none' || form.style.display === '') {
            form.style.display = 'block';
        } else {
            form.style.display = 'none';
        }
    }
</script>

