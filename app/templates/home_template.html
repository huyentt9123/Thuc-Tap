<!DOCTYPE html>
<html>
<head>
    <title>Trang chủ</title>
    <link rel="stylesheet" href="/static/home.css">
    <script>
        function toggleCreateNote() {
            var form = document.getElementById('create-note');
            if (form.style.display === 'none' || form.style.display === '') {
                form.style.display = 'block';
            } else {
                form.style.display = 'none';
            }
        }
    </script>
</head>
<body>
    <div class="home-container">
        <div class="btn-logout">
            <button onclick="window.location.href='/auth/login'">Logout</button>
        </div>
        <div class="home__form">
            <div class="home__content">
                <h1 class="home__title">Chào mừng bạn đến với Notepad !</h1>
                <!-- Menu -->
                <nav class="menu-bar">
                    <button type="button" class="btn-menu" onclick="toggleCreateNote()">
                        <span style="font-size:18px;">&#9998;</span> Tạo ghi chú
                    </button>
                    <a href="/home" class="btn-menu btn-menu-secondary">
                        <span style="font-size:18px;">&#128196;</span> Xem tất cả ghi chú
                    </a>
                    <span style="margin-left:10px;">Xem theo phân loại:</span>
                    <form method="get" action="/home" style="display:inline;">
                        <select name="category_id" onchange="this.form.submit()">
                            <option value="">-- Tất cả --</option>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if selected_category == category.id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select>
                    </form>
                </nav>
                <!-- Form tạo/sửa ghi chú -->
                {% if note_to_edit %}
                <div id="edit-note" style="margin-bottom: 30px;">
                    <form action="/notes/update" method="post">
                        <input type="hidden" name="note_id" value="{{ note_to_edit.id }}">
                        <label for="edit_title">Tiêu đề:</label>
                        <input type="text" id="edit_title" name="title" required value="{{ note_to_edit.title }}"><br>
                        <label for="edit_content">Nội dung:</label>
                        <div style="margin-bottom: 6px;">
                            <button type="button" onclick="insertTag('<b>', '</b>', 'edit_content')"><b>B</b></button>
                            <button type="button" onclick="insertTag('<i>', '</i>', 'edit_content')"><i>I</i></button>
                            <button type="button" onclick="insertTag('<ul><li>', '</li></ul>', 'edit_content')">UL</button>
                        </div>
                        <textarea id="edit_content" name="content" required style="width:100%;height:60px;">{{ note_to_edit.content }}</textarea><br>
                        <label for="edit_category">Loại ghi chú:</label>
                        <select id="edit_category" name="category_id" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}" {% if category.id == note_to_edit.category_id %}selected{% endif %}>{{ category.name }}</option>
                            {% endfor %}
                        </select><br>
                        <button type="submit" class="btn btn--submit">Cập nhật ghi chú</button>
                        <a href="/home" style="margin-left:10px;">Hủy</a>
                    </form>
                </div>
                {% else %}
                <div id="create-note" style="margin-bottom: 30px; display: none;">
                    <form action="/notes/create" method="post">
                        <label for="title">Tiêu đề:</label>
                        <input type="text" id="title" name="title" required><br>
                        <label for="content">Nội dung:</label>
                        <!-- Các nút định dạng -->
                        <div style="margin-bottom: 6px;">
                            <button type="button" onclick="insertTag('<b>', '</b>')"><b>B</b></button>
                            <button type="button" onclick="insertTag('<i>', '</i>')"><i>I</i></button>
                            <button type="button" onclick="insertTag('<ul><li>', '</li></ul>')">UL</button>
                        </div>
                        <textarea id="content" name="content" required style="width:100%;height:60px;"></textarea><br>
                        <label for="category">Loại ghi chú:</label>
                        <select id="category" name="category_id" required>
                            {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                            {% endfor %}
                        </select><br>
                        <button type="submit" class="btn btn--submit">Tạo ghi chú</button>
                    </form>
                </div>
                {% endif %}
                <!-- Danh sách ghi chú -->
                <h2 style="margin-bottom:10px;">Danh sách ghi chú của bạn</h2>
                {% if notes and notes|length > 0 %}
                    <ul class="note-list">
                    {% for note in notes %}
                        <li>
                            <span class="note-title">{{ note.title }}</span>
                            <span class="note-date">
                                ({% if note.created_at %}
                                    {# Nếu là datetime object #}
                                    {% if note.created_at.strftime is defined %}
                                        {{ note.created_at.strftime('%d/%m/%Y %H:%M') }}
                                    {% else %}
                                        {# Nếu là string ISO, cắt chuỗi #}
                                        {{ note.created_at[:16].replace('T', ' ') }}
                                    {% endif %}
                                {% endif %})
                            </span><br>
                            <div style="margin: 8px 0;">{{ note.content | safe }}</div>
                            <span class="note-category">Phân loại: 
                                {% for category in categories %}
                                    {% if category.id == note.category_id %}{{ category.name }}{% endif %}
                                {% endfor %}
                            </span>
                            <form action="/notes/delete" method="post" style="display:inline; margin-left:10px;">
                                <input type="hidden" name="note_id" value="{{ note.id }}">
                                <button type="submit" class="btn btn--delete" title="Xóa ghi chú" onclick="return confirm('Bạn có chắc muốn xóa ghi chú này?');" style="background:none; border:none; cursor:pointer; padding:0;">
                                    <!-- Trash icon SVG màu đỏ -->
                                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                </button>
                            </form>
                            <form action="/home" method="get" style="display:inline;">
                                <input type="hidden" name="edit_id" value="{{ note.id }}">
                                <button type="submit" class="btn btn--edit" title="Sửa ghi chú" style="background:none; border:none; cursor:pointer; padding:0;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M11 5H6a2 2 0 0 0-2 2v11.5A1.5 1.5 0 0 0 5.5 20H17a2 2 0 0 0 2-2v-5"/>
                                        <path d="M16.121 3.879a3 3 0 1 1 4.243 4.243L12 16.5l-4 1 1-4 7.121-7.121z"/>
                                    </svg>
                                </button>
                            </form>

                        </li>
                    {% endfor %}
                    </ul>
                {% else %}
                    <p style="color:var(--gray);">Bạn chưa có ghi chú nào.</p>
                {% endif %}
            </div>
        </div>
        <div class="circle circle--red"></div>
        <div class="circle circle--yellow"></div>
        <div class="circle circle--green"></div>
        <div class="circle circle--purple"></div>
    </div>
</body>
</html>

<script>
function insertTag(openTag, closeTag, textareaId) {
    var textarea = document.getElementById(textareaId || 'content');
    var start = textarea.selectionStart;
    var end = textarea.selectionEnd;
    var text = textarea.value;
    var before = text.substring(0, start);
    var selected = text.substring(start, end);
    var after = text.substring(end, text.length);
    textarea.value = before + openTag + selected + closeTag + after;
    // Đặt lại vị trí con trỏ
    textarea.focus();
    textarea.selectionStart = textarea.selectionEnd = start + openTag.length + selected.length + closeTag.length;
}
</script>

